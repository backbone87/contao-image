<?php

use bbit\image\op\ThumbnailOp;

echo 'TEST BBIT IMAGE RESAMPLE';

use bbit\image\format\JPEGFormat;

use bbit\image\format\PNGFormat;

use bbit\image\util\Size;

use bbit\image\op\WatermarkOp;

use bbit\image\format\ImageFormat;

define('IMAGE_TEST_RESAMPLE_DIR', 'C:\\Users\\backbone\\Volumes\\FILES_ONE (200GB Intern)\\Dropbox\\BasisDigital vs. Hofff\\CREATIVE');
define('WATERMARK_BASE', 'C:\\Users\\backbone\\Volumes\\FILES_ONE (200GB Intern)\\Dropbox\\BasisDigital vs. Hofff\\THE COLOR RUN\\Watermarks\\');
define('WATERMARK_LEFT', WATERMARK_BASE . 'thecolorrun_white.png');
define('WATERMARK_RIGHT', WATERMARK_BASE . 'watermark_magenta.png');

$op = new WatermarkOp();
$op->setWatermark(ImageFormat::autoload(WATERMARK_LEFT));
$op->setPosition(WatermarkOp::POSITION_TOP_LEFT);
$op->setRefSize(Size::create(0, 3000));
$GLOBALS['WATERMARK_LEFT'] = $op;

$op = new WatermarkOp();
$op->setWatermark(ImageFormat::autoload(WATERMARK_RIGHT));
$op->setPosition(WatermarkOp::POSITION_TOP_RIGHT);
$op->setRefSize(Size::create(0, 3000));
$GLOBALS['WATERMARK_RIGHT'] = $op;

function image_test_resample($file) {
	$file = IMAGE_TEST_RESAMPLE_DIR . '/' . $file;
	if(!is_file($file)) {
		return;
	}
	try {
		echo '<pre>';
		echo $file, PHP_EOL;
		echo '</pre>';

		$format = new JPEGFormat();
		$canvas = ImageFormat::autoload($file);

// 		$op = new ThumbnailOp();
// 		$op->setMode(ThumbnailOp::MODE_FIT);
// 		$op->setTargetSize(Size::create(400, 400));
// 		$op->setSubject($canvas);
// 		$canvas = $op->execute();

		echo '<img src="data:image/jpeg;base64,' . base64_encode($format->getBinary($canvas)) . '"
			width="' . $canvas->getSize()->getWidth() . '" height="' . $canvas->getSize()->getHeight() . '" />';

		$canvas = $GLOBALS['WATERMARK_RIGHT']->setSubject($canvas)->execute();
		$canvas = $GLOBALS['WATERMARK_LEFT']->setSubject($canvas)->execute();

		echo '<img src="data:image/jpeg;base64,' . base64_encode($format->getBinary($canvas)) . '"
			width="' . $canvas->getSize()->getWidth() . '" height="' . $canvas->getSize()->getHeight() . '" />';

		unset($canvas);

	} catch(Exception $e) {

		echo '<pre>';
		echo $e->getMessage();
		echo $e->getTraceAsString();
		echo '</pre>';

	}
}

array_map('image_test_resample', array_slice(scan(IMAGE_TEST_RESAMPLE_DIR), 0, 5));
